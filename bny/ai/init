#!/usr/bin/env bun
//
// bny ai init — bootstrap AI tool awareness of bny
//
// creates symlinks pointing each agent's context file to bny/AGENTS.md
//
// usage:
//   bny ai init                    # all known agents
//   bny ai init claude gemini      # specific agents
//

import { existsSync, mkdirSync, symlinkSync, readlinkSync, unlinkSync } from "node:fs"
import { resolve, dirname, relative } from "node:path"
import { success, error } from "../../src/lib/result.ts"
import { find_root } from "../lib/feature.ts"

// -- agent registry --

interface AgentEntry {
  name:    string
  file:    string   // relative to project root
  target:  string   // symlink target relative to file's parent dir
}

function agent_registry(root: string): AgentEntry[] {
  const protocol = "bny/AGENTS.md"

  // for files at root level, target is just the protocol path
  // for nested files, compute relative path back to protocol
  const entries: AgentEntry[] = [
    { name: "claude",     file: "CLAUDE.md",                                target: protocol },
    { name: "gemini",     file: "GEMINI.md",                                target: protocol },
    { name: "agents",     file: "AGENTS.md",                                target: protocol },
    { name: "copilot",    file: ".github/agents/copilot-instructions.md",   target: "../../" + protocol },
    { name: "cursor",     file: ".cursor/rules/bny.mdc",                    target: "../../" + protocol },
    { name: "windsurf",   file: ".windsurf/rules/bny.md",                   target: "../../" + protocol },
    { name: "kilocode",   file: ".kilocode/rules/bny.md",                   target: "../../" + protocol },
    { name: "auggie",     file: ".augment/rules/bny.md",                    target: "../../" + protocol },
    { name: "roo",        file: ".roo/rules/bny.md",                        target: "../../" + protocol },
    { name: "qwen",       file: "QWEN.md",                                  target: protocol },
    { name: "codebuddy",  file: "CODEBUDDY.md",                             target: protocol },
    { name: "qoder",      file: "QODER.md",                                 target: protocol },
    { name: "shai",       file: "SHAI.md",                                   target: protocol },
  ]

  return entries
}

// -- args --

const argv = process.argv.slice(2)

if (argv.includes("--help") || argv.includes("-h")) {
  process.stdout.write(`usage: bny ai init [agent...]

agents: claude, gemini, agents, copilot, cursor, windsurf, kilocode, auggie, roo, qwen, codebuddy, qoder, shai

no args = all known agents
`)
  process.exit(0)
}

// -- main --

const root = find_root()
const registry = agent_registry(root)
const requested = argv.length > 0 ? argv : registry.map(e => e.name)

const created:  string[] = []
const skipped:  string[] = []
const updated:  string[] = []
const unknown:  string[] = []

for (const name of requested) {
  const entry = registry.find(e => e.name === name)
  if (!entry) {
    unknown.push(name)
    continue
  }

  const abs_path = resolve(root, entry.file)
  const parent = dirname(abs_path)

  // ensure parent dir exists
  if (!existsSync(parent)) {
    mkdirSync(parent, { recursive: true })
  }

  // check if symlink already correct
  try {
    const current = readlinkSync(abs_path)
    if (current === entry.target) {
      skipped.push(entry.name)
      continue
    }
    // stale symlink — remove and recreate
    unlinkSync(abs_path)
    symlinkSync(entry.target, abs_path)
    updated.push(entry.name)
  } catch {
    // not a symlink or doesn't exist
    if (existsSync(abs_path)) {
      // real file exists — remove and replace with symlink
      unlinkSync(abs_path)
    }
    symlinkSync(entry.target, abs_path)
    created.push(entry.name)
  }
}

// -- output --

if (unknown.length > 0) {
  process.stderr.write(`bny ai init: unknown agents: ${unknown.join(", ")}\n`)
}

const meta = {
  path: "/bny/ai/init",
  timestamp: new Date().toISOString(),
  duration_ms: 0,
}

if (unknown.length > 0 && created.length === 0 && updated.length === 0 && skipped.length === 0) {
  const result = error({ agents: [{ code: "unknown", message: `unknown agents: ${unknown.join(", ")}` }] })
  process.stdout.write(JSON.stringify(result, null, 2) + "\n")
  process.exitCode = 1
} else {
  const result = success({ created, updated, skipped, unknown }, meta)
  process.stdout.write(JSON.stringify(result, null, 2) + "\n")
}

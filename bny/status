#!/usr/bin/env bun
//
// bny status â€” show current feature state
//
// usage:
//   bny status              # current feature or all features
//   bny status 001-auth     # specific feature
//   bny status --json       # machine-readable output
//

import { success } from "../src/lib/result.ts"
import {
  find_root, current_feature, feature_state, list_features,
} from "./lib/feature.ts"

const argv = process.argv.slice(2)
let json_mode = false
let target: string | null = null

for (const arg of argv) {
  if (arg === "--json") json_mode = true
  else if (arg === "--help" || arg === "-h") {
    process.stdout.write("usage: bny status [--json] [feature-name]\n")
    process.exit(0)
  } else {
    target = arg
  }
}

const root = find_root()
const name = target || current_feature()

// -- single feature --

if (name) {
  const state = feature_state(root, name)

  if (json_mode) {
    const meta = { path: "/bny/status", timestamp: new Date().toISOString(), duration_ms: 0 }
    process.stdout.write(JSON.stringify(success(state, meta), null, 2) + "\n")
  } else {
    const check = (ok: boolean) => ok ? "[x]" : "[ ]"
    process.stdout.write(`feature: ${state.name}\n`)
    process.stdout.write(`phase:   ${state.phase}\n`)
    process.stdout.write(`\n`)
    process.stdout.write(`  ${check(state.has_spec)} spec.md\n`)
    process.stdout.write(`  ${check(state.has_plan)} plan.md\n`)
    process.stdout.write(`  ${check(state.has_tasks)} tasks.md\n`)
  }
  process.exit(0)
}

// -- all features --

const features = list_features(root)

if (features.length === 0) {
  if (json_mode) {
    const meta = { path: "/bny/status", timestamp: new Date().toISOString(), duration_ms: 0 }
    process.stdout.write(JSON.stringify(success({ features: [] }, meta), null, 2) + "\n")
  } else {
    process.stdout.write("no features found\n")
  }
  process.exit(0)
}

if (json_mode) {
  const meta = { path: "/bny/status", timestamp: new Date().toISOString(), duration_ms: 0 }
  process.stdout.write(JSON.stringify(success({ features }, meta), null, 2) + "\n")
} else {
  for (const f of features) {
    const pad = f.phase.padEnd(9)
    process.stdout.write(`${f.name}  ${pad}  spec:${f.has_spec ? "+" : "-"} plan:${f.has_plan ? "+" : "-"} tasks:${f.has_tasks ? "+" : "-"}\n`)
  }
}

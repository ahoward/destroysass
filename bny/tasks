#!/usr/bin/env bun
//
// bny tasks — create task list from template
//
// usage:
//   bny tasks              # uses current feature branch
//   bny tasks 001-auth     # explicit feature
//

import { copyFileSync, existsSync } from "node:fs"
import { resolve } from "node:path"
import { success, error } from "../src/lib/result.ts"
import { find_root, current_feature, feature_paths } from "./lib/feature.ts"

const root = find_root()
const name = process.argv[2] || current_feature()

if (!name) {
  const result = error({ feature: [{ code: "not_found", message: "no feature specified and not on a feature branch" }] })
  process.stdout.write(JSON.stringify(result, null, 2) + "\n")
  process.exitCode = 1
  process.exit()
}

const paths = feature_paths(root, name)

// guard: plan.md must exist
if (!existsSync(paths.plan)) {
  const result = error({ plan: [{ code: "missing", message: `${paths.plan} does not exist — run bny plan first` }] })
  process.stdout.write(JSON.stringify(result, null, 2) + "\n")
  process.exitCode = 1
  process.exit()
}

// guard: tasks.md already exists
if (existsSync(paths.tasks)) {
  const result = error({ tasks: [{ code: "exists", message: `${paths.tasks} already exists` }] })
  process.stdout.write(JSON.stringify(result, null, 2) + "\n")
  process.exitCode = 1
  process.exit()
}

// copy template
const template = resolve(root, "bny/templates/tasks-template.md")
if (existsSync(template)) {
  copyFileSync(template, paths.tasks)
} else {
  Bun.write(paths.tasks, "")
}

const meta = {
  path: "/bny/tasks",
  timestamp: new Date().toISOString(),
  duration_ms: 0,
}
const result = success({ feature: name, tasks_file: paths.tasks }, meta)
process.stdout.write(JSON.stringify(result, null, 2) + "\n")
